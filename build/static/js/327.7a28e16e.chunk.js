(self.webpackChunk_1_front_end=self.webpackChunk_1_front_end||[]).push([[327],{327:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>E});var n=t(43),a=t(216),r=t(617),i=t(213),c=t(536),o=t.n(c),l=t(178),d=t(3),m=t(765),u=t(579);const h=t(712),g=e=>{let{searchText:s,setIsSearching:t}=e;const c=(0,a.Zp)(),g=(0,d.wA)(),[x,f]=(0,n.useState)([]),[p,v]=(0,n.useState)(1),[j,N]=(0,n.useState)(1),[y,b]=(0,n.useState)(!1),[w,k]=(0,n.useState)(!0),[S,I]=(0,n.useState)(),A=(0,n.useRef)(null),M=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(s.trim()){b(!0),I();try{const n=await i.A.get(h.searchUser,{params:{search:s,page:e,limit:20},headers:{Authorization:`Bearer ${(0,l.Ri)("accessToken")}`}}),{users:a,totalPages:r,currentPage:c}=n.data;f((e=>t?[...e,...a]:a)),v(c),N(r),k(c<r)}catch(a){if(404===a.status)f([]),k(!0),I(a.response.data.message);else if((401===a.response.status||403===a.response.status)&&!n){if((await(0,r.v)()).success)return M(e,t,!0);c("/")}}finally{b(!1)}}};(0,n.useEffect)((()=>{const e=o().debounce((()=>M(1,!1)),500);return s.trim()&&e(),()=>e.cancel()}),[s]);const C=()=>{const e=A.current;e&&e.scrollTop+e.clientHeight>=e.scrollHeight-100&&!y&&w&&M(p+1,!0)};(0,n.useEffect)((()=>{const e=A.current;return e&&e.addEventListener("scroll",C),()=>{e&&e.removeEventListener("scroll",C)}}),[y,w,p]);return(0,u.jsxs)("div",{ref:A,style:{height:"100%",maxHeight:"100%",overflowY:"auto"},children:[(0,u.jsx)("h3",{}),(0,u.jsx)("ul",{children:x.map((e=>(0,u.jsxs)("div",{className:"room-item d-flex align-items-center p-2",onClick:()=>async function(e){let s=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;b(!0),I();try{const s=await i.A.post(h.createRoom,{targetUserId:e},{headers:{Authorization:`Bearer ${(0,l.Ri)("accessToken")}`}});!0===s.data.success&&(g((0,m.pu)({roomId:s.data.roomId,profilePicture:a,userName:n,email:o})),t(!1))}catch(d){if(400===d.status)g((0,m.pu)({roomId:d.response.data.roomId,profilePicture:a,userName:n,email:o})),t(!1);else if(404===d.status)I(d.response.data.message);else if(401!==d.response.status&&403!==d.response.status||s)I(d.response.data.message);else{if((await(0,r.v)()).success)return M(e,!0);c("/")}}finally{b(!1)}}(e.userId,!1,e.userName,e.profilePicture,e.email),children:[(0,u.jsx)("div",{className:"room-image",children:(0,u.jsx)("img",{src:e.profilePicture,alt:e.userName||"user Image",className:"img-fluid rounded-circle"})}),(0,u.jsxs)("div",{className:"room-content flex-grow-1 ms-3",children:[(0,u.jsx)("div",{className:"d-flex justify-content-between align-items-center",children:(0,u.jsx)("h5",{className:"mb-0 text-truncate",children:e.userName||e.roomName||"Ph\xf2ng chat"})}),(0,u.jsx)("div",{className:"d-flex justify-content-between align-items-center mt-1",children:(0,u.jsx)("p",{className:"mb-0 text-truncate text-muted",children:e.email})})]})]})))}),y&&(0,u.jsxs)("div",{className:"text-center",children:[(0,u.jsx)("div",{className:"spinner-border text-primary",role:"status",children:(0,u.jsx)("span",{className:"visually-hidden",children:"\u0110ang t\u1ea3i..."})}),(0,u.jsx)("p",{children:"\u0110ang t\u1ea3i..."})]}),S&&(0,u.jsx)("h4",{className:"text-center text-danger",children:S}),!w&&1!=j&&(0,u.jsx)("h5",{className:"text-center text-primary",children:"\u0110\xe3 hi\u1ec3n th\u1ecb t\u1ea5t c\u1ea3 k\u1ebft qu\u1ea3."})]})},x=e=>{let{room:s,handleSelectView:t,isMobile:n}=e;const a=(0,d.wA)(),r=(0,d.d4)((e=>e.chat));return(0,u.jsxs)("div",{className:"room-item d-flex align-items-center p-2",onClick:()=>{a((0,m.pu)({roomId:s.roomId,profilePicture:s.image,userName:s.userName,email:s.email})),console.log("isMobile",n),n&&t()},children:[(0,u.jsx)("div",{div:!0,className:"room-image",children:(0,u.jsx)("img",{src:s.image,alt:s.userName||"Room Image",className:"img-fluid rounded-circle"})}),(0,u.jsxs)("div",{className:"room-content flex-grow-1 ms-3",children:[(0,u.jsxs)("div",{div:!0,className:"d-flex justify-content-between align-items-center",children:[(0,u.jsx)("h5",{className:"mb-0 text-truncate",children:s.userName||s.roomName||"Ph\xf2ng chat"}),(0,u.jsx)("small",{className:"text-muted",children:s.lastMessageTime})]}),(0,u.jsxs)("div",{div:!0,className:"d-flex justify-content-between align-items-center mt-1",children:[(0,u.jsx)("p",{className:"mb-0 text-truncate text-muted",children:s.lastMessage}),s.unreadMessagesCount>0&&r.roomId!=s.roomId&&(0,u.jsx)("span",{className:"badge bg-danger rounded-pill unread-count",children:s.unreadMessagesCount})]})]})]})};var f=t(462),p=t(104);const v=t(712);let j=null;const N=function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const s=(0,l.Ri)("accessToken");return e&&j&&j.disconnect(),j=(0,p.io)(v.socketServer,{query:{token:s},transports:["websocket"]}),j.on("connect_error",(async e=>{if(console.error("L\u1ed7i k\u1ebft n\u1ed1i socket:",e.message),"Token kh\xf4ng t\u1ed3n t\u1ea1i."===e.message||"Token kh\xf4ng h\u1ee3p l\u1ec7 ho\u1eb7c \u0111\xe3 h\u1ebft h\u1ea1n."===e.message){(await(0,r.v)()).success?N(!0):(console.error("L\u1ed7i l\xe0m m\u1edbi token, c\u1ea7n \u0111\u0103ng nh\u1eadp l\u1ea1i"),window.location.href="/")}})),j};N();const y=t(712),b=e=>{let{handleSelectView:s,isMobile:t}=e;const c=(0,a.Zp)(),o=(0,d.wA)(),h=(0,d.d4)((e=>e.chat)),[p,v]=(0,n.useState)(!1),[j,b]=(0,n.useState)(""),[w,k]=(0,n.useState)([]),[S,I]=(0,n.useState)(),A=(0,l.Ri)("accessToken"),[M,C]=(0,n.useState)(1),[T,R]=(0,n.useState)(1),[P,E]=(0,n.useState)(!1),[L,z]=(0,n.useState)(!0),[B,$]=(0,n.useState)(),U=(0,n.useRef)(null),D=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,s=arguments.length>1&&void 0!==arguments[1]&&arguments[1],t=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3?arguments[3]:void 0;try{E(!0),$();const t=await i.A.get(y.getUserRooms,{params:{page:e,limit:15},headers:{Authorization:`Bearer ${A}`}});if(200===t.status){const{rooms:e,totalPages:a,currentPage:r}=t.data;k((t=>s?[...t,...e]:e)),!h.roomId&&n&&o((0,m.pu)({roomId:t.data.rooms[0].roomId,profilePicture:t.data.rooms[0].image,userName:t.data.rooms[0].userName,email:t.data.rooms[0].email})),C(r),R(a),z(r<a)}}catch(a){if(404===a.status)k([]),z(!0),$(a.response.data.message);else if((401===a.response.status||403===a.response.status)&&!t){if((await(0,r.v)()).success)return D(e,s,!0,n);c("/")}}finally{E(!1)}};(0,n.useEffect)((()=>{const e=N();return e.on("updateRoomList",(()=>{D(1,!1,!1,!1)})),()=>{e.off("updateRoomList"),e.disconnect()}}),[]);const H=()=>{const e=U.current;e&&e.scrollTop+e.clientHeight>=e.scrollHeight-100&&!P&&L&&D(M+1,!0)};(0,n.useEffect)((()=>{const e=U.current;return e&&e.addEventListener("scroll",H),()=>{e&&e.removeEventListener("scroll",H)}}),[P,L,M]),(0,n.useEffect)((()=>{D(1,!1,!1,!0)}),[h.roomId]);const V=(0,n.useRef)();return(0,u.jsxs)("div",{className:"room-list-container",children:[(0,u.jsx)("h1",{className:"room-list-title",children:"\u0110o\u1ea1n chat"}),(0,u.jsxs)("div",{className:"search-bar",children:[p&&(0,u.jsx)("button",{className:"back-button",onClick:()=>{v(!1),b("")},children:(0,u.jsx)(f.atu,{size:20})}),(0,u.jsx)("input",{type:"text",className:"search-input",placeholder:"T\xecm ki\u1ebfm ng\u01b0\u1eddi d\xf9ng...",value:j,onChange:e=>b(e.target.value),onFocus:()=>v(!0),ref:V}),j&&(0,u.jsx)("button",{className:"btn btn-close",onClick:()=>{b(""),V.current.focus()}})]}),(0,u.jsxs)("div",{className:"room-list-content",ref:U,children:[p?(0,u.jsx)(g,{searchText:j,setIsSearching:v}):S?(0,u.jsx)("h5",{className:"text-center text-secondary",children:S}):w.map((e=>(0,u.jsx)(x,{room:e,handleSelectView:s,isMobile:t},e.roomId))),P&&(0,u.jsxs)("div",{className:"text-center",children:[(0,u.jsx)("div",{className:"spinner-border text-primary",role:"status",children:(0,u.jsx)("span",{className:"visually-hidden",children:"\u0110ang t\u1ea3i..."})}),(0,u.jsx)("p",{children:"\u0110ang t\u1ea3i..."})]}),B&&(0,u.jsx)("h4",{className:"text-center text-danger",children:B}),!L&&1!=T&&(0,u.jsx)("h5",{className:"text-center text-primary mt-2",children:"\u0110\xe3 hi\u1ec3n th\u1ecb t\u1ea5t c\u1ea3 ph\xf2ng chat."})]})]})};var w=t(184);const k=t(712),S=()=>{const e=(0,a.Zp)(),s=(0,d.d4)((e=>e.auth.user)),[t,c]=(0,n.useState)(""),[o,m]=(0,n.useState)(""),[h,g]=(0,n.useState)(!1),[x,p]=(0,n.useState)(!1),[v,j]=(0,n.useState)(!1),[N,y]=(0,n.useState)(!1),[b,S]=(0,n.useState)("");(0,n.useEffect)((()=>{console.log("userInfo",s)}),[s]);const[I,A]=(0,n.useState)(s.profilePicture?s.profilePicture:void 0),[M,C]=(0,n.useState)(s.userName?s.userName:null),[T,R]=(0,n.useState)(""),[P,E]=(0,n.useState)(""),[L,z]=(0,n.useState)(""),[B,$]=(0,n.useState)();function U(){const e=(0,n.useRef)(null);return(0,u.jsx)("div",{className:"form-group",children:(0,u.jsxs)("div",{style:{width:"100%",textAlign:"center",margin:"1% 0 2% 0"},onClick:()=>{e.current.click()},onDrop:e=>{e.preventDefault(),c(null);const s=e.dataTransfer.files[0];if(s)if(s.type.startsWith("image/")){const e=new FileReader;e.onload=()=>{A(s)},e.readAsDataURL(s),c(null),g(!0)}else c("B\u1ea1n ch\u1ec9 c\xf3 th\u1ec3 ch\u1ecdn file h\xecnh \u1ea3nh.")},onDragOver:e=>{e.preventDefault(),c(null),g(!0)},children:[!I&&(0,u.jsxs)("span",{children:[(0,u.jsx)("span",{style:{color:"blue"},children:"Ch\u1ecdn file"})," ho\u1eb7c K\xe9o v\xe0 th\u1ea3 \u1ea3nh v\xe0o \u0111\xe2y"]}),(0,u.jsx)("input",{ref:e,type:"file",accept:"image/*",style:{display:"none"},onChange:e=>{const s=e.target.files[0];if(s)if(s.type.startsWith("image/")){const e=new FileReader;e.onload=()=>{A(s)},e.readAsDataURL(s),c(null),g(!0)}else c("B\u1ea1n ch\u1ec9 c\xf3 th\u1ec3 ch\u1ecdn file h\xecnh \u1ea3nh.");else A(void 0)}}),I&&(0,u.jsxs)("div",{style:{position:"relative",display:"inline-block"},children:[(0,u.jsx)("img",{src:B,alt:"Selected",style:{width:"200px",height:"200px",objectFit:"cover",borderRadius:"50%",border:"5px solid #007bff",boxShadow:"rgba(0, 0, 0, 0.05) 0px 20px 27px 0px"}}),(0,u.jsx)(f.Ek,{style:{position:"absolute",bottom:0,right:0,cursor:"pointer",width:20,height:20}})]})]})})}(0,n.useEffect)((()=>{I&&I instanceof File?$(URL.createObjectURL(I)):$(I),console.log("hinh anh",I)}),[I]);return(0,n.useEffect)((()=>{""===M&&p(!1)}),[M]),(0,n.useEffect)((()=>{""!==T&&""!==P&&""!==L||j(!1)}),[T,P,L]),(0,u.jsxs)("div",{children:[(0,u.jsx)("h2",{style:{width:"100%",textAlign:"center",fontWeight:"bolder"},children:"Th\xf4ng Tin Ng\u01b0\u1eddi D\xf9ng"}),(0,u.jsx)("div",{className:"mt-3",style:{width:"100%",textAlign:"center"},children:(0,u.jsx)(U,{})}),(0,u.jsx)("h1",{style:{textAlign:"center",marginBottom:"0"},children:M}),(0,u.jsx)("p",{style:{textAlign:"center"},children:s.email}),(0,u.jsx)("label",{children:"T\xean ng\u01b0\u1eddi d\xf9ng"}),(0,u.jsx)("div",{className:"mb-3 mt-2",children:(0,u.jsx)("input",{style:{border:"gray 1px solid"},type:"text",className:"form-control-lg w-100",value:M,onChange:e=>{p(!0),C(e.target.value),m("")},required:!0,placeholder:"T\xean ng\u01b0\u1eddi d\xf9ng"})}),(0,u.jsx)("h4",{className:"mt-5",children:"\u0110\u1ed5i M\u1eadt Kh\u1ea9u"}),(0,u.jsxs)("div",{className:"form-group",children:[(0,u.jsx)("label",{children:"M\u1eadt Kh\u1ea9u C\u0169"}),(0,u.jsx)("input",{type:"password",className:"form-control",value:T,onChange:e=>{j(!0),R(e.target.value),m("")},required:!0})]}),(0,u.jsxs)("div",{className:"form-group",children:[(0,u.jsx)("label",{children:"M\u1eadt Kh\u1ea9u M\u1edbi"}),(0,u.jsx)("input",{type:"password",className:"form-control",value:P,onChange:e=>{j(!0),E(e.target.value),m("")},required:!0})]}),(0,u.jsxs)("div",{className:"form-group",children:[(0,u.jsx)("label",{children:"Nh\u1eadp L\u1ea1i M\u1eadt Kh\u1ea9u M\u1edbi"}),(0,u.jsx)("input",{type:"password",className:"form-control",value:L,onChange:e=>{j(!0),z(e.target.value),m("")},required:!0})]}),t&&(0,u.jsx)("p",{style:{color:"red"},className:"text-center",children:t}),o&&(0,u.jsx)("p",{style:{color:"red"},className:"text-center",children:o}),b&&(0,u.jsx)("p",{className:"text-center text-primary",children:b}),(0,u.jsx)("div",{className:"d-flex justify-content-center mt-3",children:(0,u.jsx)("button",{className:"btn btn-primary",disabled:!(h||x||v)||N,onClick:()=>(async()=>{if(m(""),S(""),h){const s=async function(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];try{y(!0);const e=new FormData;e.append("profilePicture",I);const s=await i.A.post(k.updateProfilePicture,e,{headers:{"Content-Type":"multipart/form-data",Authorization:`Bearer ${(0,l.Ri)("accessToken")}`}});S(s.data.message)}catch(o){if(401!==o.response.status&&403!==o.response.status||t)m(o.response.data.message);else{if((await(0,r.v)()).success)return s(!0);e("/")}}finally{y(!1)}};s(!1)}if(x){const s=async function(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(M)try{y(!0);const e=await i.A.put(k.updateUserName,{userName:M},{headers:{Authorization:`Bearer ${(0,l.Ri)("accessToken")}`}});S(e.data.message)}catch(o){if(401!==o.response.status&&403!==o.response.status||t)m(o.response.data.message);else{if((await(0,r.v)()).success)return s(!0);e("/")}}finally{y(!1)}else m("Vui l\xf2ng nh\u1eadp \u0111\u1ea7y \u0111\u1ee7 th\xf4ng tin")};s(!1)}if(v){const s=async function(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(T&&P&&L)if(P.trim()===L.trim())try{y(!0);const e=await i.A.post(k.changePassword,{oldPassword:T,newPassword:P},{headers:{Authorization:`Bearer ${(0,l.Ri)("accessToken")}`},withCredentials:!0});S(e.data.message)}catch(o){if(401!==o.response.status&&403!==o.response.status||t)m(o.response.data.message);else{if((await(0,r.v)()).success)return s(!0);e("/")}}finally{y(!1)}else m("M\u1eadt kh\u1ea9u m\u1edbi v\xe0 nh\u1eadp l\u1ea1i m\u1eadt kh\u1ea9u kh\xf4ng kh\u1edbp");else m("Vui l\xf2ng nh\u1eadp \u0111\u1ea7y \u0111\u1ee7 th\xf4ng tin")};s(!1)}})(),children:N?"\u0110ang x\u1eed l\xfd":"X\xe1c Nh\u1eadn"})}),(0,u.jsx)("div",{className:"d-flex justify-content-end mt-3",children:(0,u.jsxs)("button",{className:"btn btn-warning",onClick:()=>(async()=>{try{(await i.A.post(k.logout,{},{withCredentials:!0})).data.success&&((0,l.Yj)("accessToken"),e("/"))}catch(o){m(o.response.data.message)}})(),children:["\u0110\u0103ng Xu\u1ea5t ",(0,u.jsx)(w.axc,{})]})})]})},I=e=>{let{handleSelectView:s,isMobile:t}=e;const a=(0,d.d4)((e=>e.chat)),[r,i]=(0,n.useState)("chat");(0,n.useEffect)((()=>{}),[a.roomId]);return(0,u.jsxs)("div",{className:"room-container d-flex flex-column shadow p-3 ms-3 mt-3 me-3 rounded",children:[(0,u.jsx)("div",{className:"room-content flex-grow-1",children:"chat"===r?(0,u.jsx)(b,{handleSelectView:s,isMobile:t}):"settings"===r?(0,u.jsx)(S,{}):void 0}),(0,u.jsxs)("div",{className:"room-nav d-flex justify-content-around align-items-center",children:[(0,u.jsxs)("button",{className:"nav-button "+("chat"===r?"active":""),onClick:()=>i("chat"),children:[(0,u.jsx)(f.GGi,{size:24}),(0,u.jsx)("span",{children:"\u0110o\u1ea1n chat"})]}),(0,u.jsxs)("button",{className:"nav-button "+("settings"===r?"active":""),onClick:()=>i("settings"),children:[(0,u.jsx)(f.HbA,{size:24}),(0,u.jsx)("span",{children:"C\xe0i \u0111\u1eb7t"})]})]})]})},A=()=>{const[e,s]=(0,n.useState)(""),t=(0,d.d4)((e=>e.chat)),a=(0,n.useRef)(null);return(0,n.useEffect)((()=>{a.current&&(a.current.focus(),s(""))}),[t.roomId]),(0,u.jsxs)("form",{className:"message-form d-flex align-items-center px-3 py-2",onSubmit:n=>{n.preventDefault(),e.trim()&&(j.emit("sendMessage",{roomId:t.roomId,message:e}),s(""))},children:[(0,u.jsx)("div",{className:"icon-container me-2",children:(0,u.jsx)(f.Mqx,{size:24,className:"text-muted"})}),(0,u.jsx)("input",{ref:a,type:"text",className:"form-control flex-grow-1 search-input",placeholder:"Nh\u1eadp tin nh\u1eafn...",value:e,onChange:e=>{s(e.target.value)},autoFocus:!0}),(0,u.jsx)("button",{type:"submit",className:"btn btn-primary ms-2 "+(e.trim()?"":"disabled"),disabled:!e.trim(),children:(0,u.jsx)(f.qYP,{size:20})})]})},M=(t(712),e=>{let{message:s,messageAction:t,setMessageAction:n,handleEditMessage:a,handleDeleteMessage:r}=e;(0,d.wA)();const i=(0,d.d4)((e=>e.auth.user)),c=(0,d.d4)((e=>e.chat)),o=t&&t.messageId===s.messageId;return(0,u.jsxs)("div",{children:[(0,u.jsx)("div",{className:"d-flex mt-2",children:(0,u.jsx)("small",{className:"text-muted mx-auto",children:s.createdAt})}),s.senderId!==i.userId?(0,u.jsx)("div",{className:"room-item ",children:(0,u.jsxs)("div",{className:"d-flex align-items-center p-2 pt-0",children:[(0,u.jsx)("div",{className:"room-image",onClick:()=>{alert("b\u1eadt trang c\xe1 nh\xe2n")},children:(0,u.jsx)("img",{src:c.profilePicture,alt:"",className:"img-fluid rounded-circle"})}),(0,u.jsx)("div",{className:"room-content flex-grow-1 ms-3",children:(0,u.jsx)("div",{className:"d-flex justify-content-start align-items-center",children:(0,u.jsxs)("h5",{style:{maxWidth:"80%",wordBreak:"break-word"},className:"text-wrap",children:[s.messageContent||"Tin nh\u1eafn",s.editedAt&&(0,u.jsxs)("i",{style:{display:"block",fontSize:"0.55em",fontWeight:"normal"},children:["\u0110\xe3 ch\u1ec9nh s\u1eeda: ",s.editedAt]})]})})})]})}):(0,u.jsx)("div",{className:"room-item",children:(0,u.jsxs)("div",{className:" d-flex align-items-center p-2 pt-0",onClick:()=>{n(o?null:s)},children:[(0,u.jsxs)("div",{className:"room-content flex-grow-1 me-3",children:[o&&(0,u.jsxs)("div",{className:"d-flex justify-content-end",children:[(0,u.jsx)("button",{className:"btn btn-primary",onClick:a,children:(0,u.jsx)(f.dJk,{size:15})}),(0,u.jsx)("button",{className:"btn btn-primary ms-2",onClick:r,children:(0,u.jsx)(f.WeY,{size:15})})]}),(0,u.jsx)("div",{className:"d-flex justify-content-end align-items-center",children:(0,u.jsxs)("h5",{style:{maxWidth:"80%",wordBreak:"break-word",textAlign:s.messageContent.length>20?"null":"end"},className:"text-wrap",children:[s.messageContent||"Tin nh\u1eafn",s.editedAt&&(0,u.jsxs)("i",{style:{display:"block",fontSize:"0.55em",fontWeight:"normal"},children:["\u0110\xe3 ch\u1ec9nh s\u1eeda: ",s.editedAt]})]})})]}),(0,u.jsx)("div",{className:"room-image",children:(0,u.jsx)("img",{src:i.profilePicture,alt:"",className:"img-fluid rounded-circle"})})]})})]})}),C=t(712),T=e=>{let{handleSelectView:s,isMobile:t}=e;const c=(0,a.Zp)(),o=(0,d.d4)((e=>e.chat)),[m,h]=(0,n.useState)(),[g,x]=(0,n.useState)([]),[p,v]=(0,n.useState)(1),[y,b]=(0,n.useState)(1),[w,k]=(0,n.useState)(!1),[S,I]=(0,n.useState)(!0),[T,R]=(0,n.useState)(),P=(0,n.useRef)(null),[E,L]=(0,n.useState)(!1),z=(0,n.useRef)(!1),[B,$]=(0,n.useState)(null),U=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,s=arguments.length>1&&void 0!==arguments[1]&&arguments[1],t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(o.roomId){k(!0),R();try{const t=await i.A.get(C.getMessagesByRoomId(o.roomId),{params:{page:e,limit:20},headers:{Authorization:`Bearer ${(0,l.Ri)("accessToken")}`}}),{messages:n,totalPages:a,currentPage:r}=t.data;x((e=>{const t=s?[...e,...n]:n;return[...new Map(t.map((e=>[e.messageId,e]))).values()]})),v(r),b(a),I(r<a),j.emit("joinRoom",{roomId:o.roomId})}catch(n){if(404===n.status)x([]),I(!0),R("H\xe3y b\u1eaft \u0111\u1ea7u v\u1edbi tin nh\u1eafn \u0111\u1ea7u ti\xean");else if(403===n.response.status&&"B\u1ea1n kh\xf4ng ph\u1ea3i l\xe0 th\xe0nh vi\xean c\u1ee7a ph\xf2ng n\xe0y!"===n.response.data.message)R(n.response.data.message);else if((401===n.response.status||403===n.response.status)&&!t){if((await(0,r.v)()).success)return U(e,s,!0);c("/")}}finally{k(!1)}}};(0,n.useEffect)((()=>{U(1,!1);const e=N();return e.on("joinedRoom",(e=>{e.twoMember?L(!0):L(!1)})),e.on("receiveMessage",(e=>{x((s=>[e,...s||[]]));const s=P.current;setTimeout((()=>{s.scrollTop=s.scrollHeight}),200)})),z.current=!1,e.on("messageEdited",(e=>{x((s=>s.map((s=>s.messageId===e.messageId?{...s,messageContent:e.newMessageContent,editedAt:e.editedAt}:s))))})),e.on("messageDeleted",(e=>{x((s=>s.filter((s=>s.messageId!==e.messageId))))})),()=>{e.off("joinedRoom"),e.off("receiveMessage"),e.off("messageEdited"),e.off("messageDeleted"),e.disconnect()}}),[o.roomId]),(0,n.useEffect)((()=>{const e=P.current;e&&!z.current&&e.scrollHeight>e.clientHeight&&setTimeout((()=>{e.scrollTop=e.scrollHeight,z.current=!0}),200);const s=()=>{e&&e.scrollTop<=150&&!w&&S&&U(p+1,!0)};return e&&e.addEventListener("scroll",s),()=>{e&&e.removeEventListener("scroll",s)}}),[w,S,p]),(0,n.useEffect)((()=>{console.log("messageAction",B)}),[B]);const D=async()=>{let e=prompt("S\u1eeda tin nh\u1eafn",B.messageContent);if(null!==e){e=e.trim();const s=async function(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];try{const s=(await i.A.put(C.editMessageById(B.messageId),{newMessageContent:e},{headers:{Authorization:`Bearer ${(0,l.Ri)("accessToken")}`}})).data.updatedMessage;x((e=>e.map((e=>e.messageId===s.messageId?{...e,messageContent:s.newMessageContent,editedAt:s.editedAt}:e)))),j.emit("editMessage",{messageId:s.messageId,newMessageContent:s.newMessageContent,editedAt:s.editedAt,roomId:o.roomId})}catch(n){if((401===n.response.status||403===n.response.status)&&!t){if((await(0,r.v)()).success)return s(!0);c("/")}}};s(!1)}else alert("H\xe3y nh\u1eadp n\u1ed9i dung tin nh\u1eafn")},H=async()=>{const e=async function(){let s=arguments.length>0&&void 0!==arguments[0]&&arguments[0];try{const e=await i.A.delete(C.deleteMessageById(B.messageId),{headers:{Authorization:`Bearer ${(0,l.Ri)("accessToken")}`}});x((s=>s.filter((s=>s.messageId!==e.data.messageId)))),j.emit("deleteMessage",{messageId:e.data.messageId,roomId:o.roomId})}catch(t){if((401===t.response.status||403===t.response.status)&&!s){if((await(0,r.v)()).success)return e(!0);c("/")}}};e(!1)};return(0,u.jsxs)("div",{className:"room-container d-flex flex-column shadow mt-3 p-3 ms-3 me-3 rounded",children:[(0,u.jsx)("div",{className:"",children:(0,u.jsx)("div",{className:"room-list-container",children:(0,u.jsxs)("div",{className:"room-item d-flex align-items-center p-2",children:[t&&(0,u.jsx)("button",{className:"back-button",onClick:s,children:(0,u.jsx)(f.atu,{size:20})}),(0,u.jsx)("div",{className:"room-image",children:(0,u.jsx)("img",{src:o.profilePicture,alt:o.userName||"user Image",className:"img-fluid rounded-circle"})}),(0,u.jsxs)("div",{className:"flex-grow-1 ms-3",children:[(0,u.jsx)("div",{className:"d-flex justify-content-between align-items-center",children:(0,u.jsxs)("h5",{className:"mb-0 text-truncate",children:[o.userName||o.roomName||"Ph\xf2ng chat"," ",E&&(0,u.jsx)(f.$ap,{style:{color:"#28a745",fontSize:"1rem"}})]})}),(0,u.jsx)("div",{className:"d-flex justify-content-between align-items-center mt-1",children:(0,u.jsx)("p",{className:"mb-0 text-truncate text-muted",children:o.email})})]})]})})}),(0,u.jsx)("div",{className:"room-list-container",style:{height:"100%",maxHeight:"100%",overflowY:"auto"},children:(0,u.jsxs)("div",{className:"room-list-content",ref:P,style:{height:"100%",maxHeight:"100%",overflowY:"auto"},children:[w&&(0,u.jsxs)("div",{className:"text-center",children:[(0,u.jsx)("div",{className:"spinner-border text-primary",role:"status",children:(0,u.jsx)("span",{className:"visually-hidden",children:"\u0110ang t\u1ea3i..."})}),(0,u.jsx)("p",{children:"\u0110ang t\u1ea3i..."})]}),T&&(0,u.jsx)("h4",{className:"text-center text-danger",children:T}),!S&&1!=y&&(0,u.jsx)("h5",{className:"text-center text-primary",children:"\u0110\xe3 hi\u1ec3n th\u1ecb t\u1ea5t c\u1ea3 tin nh\u1eafn."}),m?(0,u.jsx)("h5",{className:"text-center text-secondary",children:m}):[...g].reverse().map((e=>(0,u.jsx)(M,{message:e,messageAction:B,setMessageAction:$,handleEditMessage:D,handleDeleteMessage:H},e.messageId)))]})}),(0,u.jsx)("div",{className:"room-nav d-flex justify-content-around align-items-center",children:(0,u.jsx)(A,{})})]})};var R=t(110),P=t(937);const E=()=>{const[e,s]=(0,n.useState)("room"),[t,i]=(0,n.useState)(!1),[c,o]=(0,n.useState)(!1),[l,m]=(0,n.useState)(!0),h=(0,a.Zp)(),g=(0,d.wA)();(0,n.useEffect)((()=>{(async()=>{const e=await(0,r.o)();e.success?(e.user&&g((0,P.iD)({user:e.user})),m(!1)):h("/")})(),(0,R.n)();const e=()=>{o(window.innerWidth<=768)};return window.addEventListener("resize",e),e(),()=>window.removeEventListener("resize",e)}),[h,g]);const x=()=>{s("chat"===e?"room":"chat")};return l?(0,u.jsx)("div",{children:"Vui l\xf2ng ch\u1edd..."}):(0,u.jsx)("div",{className:"container-fluid h-100 messaging-page",children:(0,u.jsx)("div",{className:"row h-100",children:c?(0,u.jsx)(u.Fragment,{children:"room"===e?(0,u.jsx)("div",{className:"col-12 p-0",children:(0,u.jsx)(I,{handleSelectView:x,isMobile:c})}):(0,u.jsx)("div",{className:"col-12 p-0",children:(0,u.jsx)(T,{handleSelectView:x,isMobile:c})})}):(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)("div",{className:"col-5 p-0",children:(0,u.jsx)(I,{})}),(0,u.jsx)("div",{className:"col-7 p-0",children:(0,u.jsx)(T,{})})]})})})}},712:e=>{e.exports={socketServer:"https://backendvmess.onrender.com",getMessagesByRoomId:e=>`https://backendvmess.onrender.com/${e}/messages`,login:"https://backendvmess.onrender.com/login",googleLogin:"https://backendvmess.onrender.com/googleLogin",register:"https://backendvmess.onrender.com/register",verifyCode:"https://backendvmess.onrender.com/verifyCode",forgotPassword:"https://backendvmess.onrender.com/forgotPassword",verifyResetCode:"https://backendvmess.onrender.com/verifyResetCode",resetPassword:"https://backendvmess.onrender.com/resetPassword",logout:"https://backendvmess.onrender.com/logout",checkToken:"https://backendvmess.onrender.com/checkToken",refreshToken:"https://backendvmess.onrender.com/refreshToken",getUserRooms:"https://backendvmess.onrender.com/getUserRooms",searchUser:"https://backendvmess.onrender.com/searchUser",createRoom:"https://backendvmess.onrender.com/createRoom",editMessageById:e=>`https://backendvmess.onrender.com/editMessage/${e}`,deleteMessageById:e=>`https://backendvmess.onrender.com/deleteMessage/${e}`,updateProfilePicture:"https://backendvmess.onrender.com/updateProfilePicture",updateUserName:"https://backendvmess.onrender.com/updateUserName",changePassword:"https://backendvmess.onrender.com/changePassword"}},617:(e,s,t)=>{"use strict";t.d(s,{o:()=>i,v:()=>c});var n=t(213),a=t(178);const r=t(712),i=async()=>{try{const e=await n.A.post(r.checkToken,{},{headers:{Authorization:(0,a.Ri)("accessToken")}});if(200===e.status)return{success:!0,user:e.data.user}}catch(e){if(!e.response)return{success:!1};if(400===e.response.status||401===e.response.status){const e=await c();return e.success?{success:!0,user:e.user}:{success:!1}}if(500===e.response.status)return{success:!1}}return{success:!1}},c=async()=>{try{const e=await n.A.post(r.refreshToken,{},{withCredentials:!0});if(200===e.status)return(0,a.TV)("accessToken",e.data.accessToken,15),{success:!0,user:e.data.user}}catch(e){return!e.response||400!==e.response.status&&e.response.status,{success:!1}}}},178:(e,s,t)=>{"use strict";function n(e){const s=e+"=",t=decodeURIComponent(document.cookie).split(";");for(let n=0;n<t.length;n++){let e=t[n];for(;" "===e.charAt(0);)e=e.substring(1);if(0===e.indexOf(s))return e.substring(s.length,e.length)}return""}function a(e,s,t){const n=new Date;n.setMinutes(n.getMinutes()+t);const a=`expires=${n.toUTCString()}`;document.cookie=`${e}=${s}; ${a}`}function r(e){document.cookie=`${e}=; expires=Thu, 01 Jan 1970 00:00:00 UTC`}t.d(s,{Ri:()=>n,TV:()=>a,Yj:()=>r})},110:(e,s,t)=>{"use strict";t.d(s,{A:()=>n,n:()=>a});const n=e=>{if("dark"===e)document.body.classList.add("dark-mode"),document.body.classList.remove("light-mode");else if("light"===e)document.body.classList.add("light-mode"),document.body.classList.remove("dark-mode");else{window.matchMedia("(prefers-color-scheme: dark)").matches?(document.body.classList.add("dark-mode"),document.body.classList.remove("light-mode")):(document.body.classList.add("light-mode"),document.body.classList.remove("dark-mode"))}},a=()=>{const e=localStorage.getItem("theme");if(e)n(e);else{const e=window.matchMedia("(prefers-color-scheme: dark)").matches;n(e?"dark":"light")}}}}]);
//# sourceMappingURL=327.7a28e16e.chunk.js.map